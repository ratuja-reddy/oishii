{% extends "base.html" %}
{% block content %}

<h1 class="text-2xl font-bold mb-4">Edit Profile</h1>

<form method="post" enctype="multipart/form-data" class="space-y-6">
  {% csrf_token %}

  <section class="bg-white rounded-2xl shadow p-4 space-y-3">
    <h2 class="font-semibold">Account</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-gray-600">First name</label>
        {{ uform.first_name }}
      </div>
      <div>
        <label class="text-sm text-gray-600">Last name</label>
        {{ uform.last_name }}
      </div>
    </div>
    <div>
      <label class="text-sm text-gray-600">Email</label>
      {{ uform.email }}
    </div>
  </section>

  <section class="bg-white rounded-2xl shadow p-4 space-y-3">
    <h2 class="font-semibold">Profile</h2>
    <div>
      <label class="text-sm text-gray-600">Display name</label>
      {{ pform.display_name }}
    </div>
    <div>
      <label class="text-sm text-gray-600">Bio</label>
      {{ pform.bio }}
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-gray-600">Location</label>
        {{ pform.location }}
      </div>
      <div>
        <label class="text-sm text-gray-600">Website</label>
        {{ pform.website }}
      </div>
    </div>
    <div>
      <label class="text-sm text-gray-600 block mb-1">Avatar</label>
      {{ pform.avatar }}
    </div>
  </section>

  <section class="bg-white rounded-2xl shadow p-4 space-y-3">
    <h2 class="font-semibold">Preferences</h2>
    <div>
      <label class="text-sm text-gray-600 block mb-2">Favorite Cuisines</label>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
        {{ pform.favorite_cuisines }}
      </div>
      <div class="text-xs text-gray-500 mt-1">{{ pform.favorite_cuisines.help_text }}</div>
    </div>
    <div>
      <label class="text-sm text-gray-600 block mb-2">
        Favorite Spots (max 3)
        <span id="edit-spots-count" class="text-indigo-600 font-semibold">({{ pform.instance.favorite_spots.count }}/3)</span>
      </label>
      
      <!-- Search input -->
      <input type="text" id="edit-spots-search" placeholder="Search restaurants..." 
             class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
      
      <!-- Restaurant list with checkboxes -->
      <div id="edit-spots-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
        {% for restaurant in pform.favorite_spots.field.queryset %}
          <label class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0">
            <input type="checkbox" name="favorite_spots" value="{{ restaurant.id }}" 
                   {% if restaurant in pform.instance.favorite_spots.all %}checked{% endif %}
                   class="mr-3 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 edit-spots-checkbox">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-gray-900">{{ restaurant.name }}</div>
              <div class="text-sm text-gray-500">{{ restaurant.cuisine|title }} â€¢ {{ restaurant.city }}</div>
            </div>
          </label>
        {% endfor %}
      </div>
      
      <div class="text-xs text-gray-500 mt-2">Search and select your favorite spots</div>
    </div>
  </section>

  <button class="px-4 py-2 rounded-xl bg-gray-900 text-white">Save changes</button>
  <a href="{% url 'profile_me' %}" class="ml-2 text-gray-600 underline">Cancel</a>
</form>

<script>
// Edit profile spots search and selection functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('edit-spots-search');
  const spotsList = document.getElementById('edit-spots-list');
  const spotsCount = document.getElementById('edit-spots-count');
  const checkboxes = document.querySelectorAll('.edit-spots-checkbox');
  
  if (searchInput && spotsList && spotsCount && checkboxes.length > 0) {
    // Search functionality
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const labels = spotsList.querySelectorAll('label');
      
      labels.forEach(label => {
        const restaurantName = label.querySelector('.font-medium').textContent.toLowerCase();
        const cuisine = label.querySelector('.text-sm').textContent.toLowerCase();
        
        if (restaurantName.includes(searchTerm) || cuisine.includes(searchTerm)) {
          label.style.display = 'flex';
        } else {
          label.style.display = 'none';
        }
      });
    });
    
    // Update count and enforce limit
    function updateCount() {
      const checkedBoxes = document.querySelectorAll('.edit-spots-checkbox:checked');
      const count = checkedBoxes.length;
      
      spotsCount.textContent = `(${count}/3)`;
      
      // Disable unchecked boxes if limit reached
      if (count >= 3) {
        checkboxes.forEach(checkbox => {
          if (!checkbox.checked) {
            checkbox.disabled = true;
            checkbox.closest('label').style.opacity = '0.5';
          }
        });
      } else {
        checkboxes.forEach(checkbox => {
          checkbox.disabled = false;
          checkbox.closest('label').style.opacity = '1';
        });
      }
    }
    
    // Add event listeners to checkboxes
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const checkedBoxes = document.querySelectorAll('.edit-spots-checkbox:checked');
        
        // If trying to check a 4th box, uncheck it
        if (this.checked && checkedBoxes.length > 3) {
          this.checked = false;
          return;
        }
        
        updateCount();
      });
    });
    
    // Initial count update
    updateCount();
  }
});
</script>

{% endblock %}
